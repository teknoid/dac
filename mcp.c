//.....'::,,;;::cclooddkkkkkkkxxxdddoollccc::;;;,,,,,,,;;;;;;;;;;;;;,,,,,,,;;;::cclllooddxxxkkkkkxxddoollcc:;;,,;c,.......
//.....'cc;;;:ccloddxkkOO000000OOkkxxddoollc:::;;;;;;;;;;::::::::;;;;;;;;;;;::cllloodxxkkOO000000OOOkxxdollc::;;:c;.......
//.....':c;;;:ccloddxkkOO000000OOkkxxddoollc::;;;;;;;;;;;::::::::;;;;;;;;;;;::cllloodxxkkOOO00000OOOkxxdollc::;;:c;.......
//.....':c;;;:ccloddxkkOO000000OOkkxxddoollc::;;;;;;;;;;;::::::::;;;;;;;;;;;::cllloodxxkkOOO00000OOOkxxdollc::;;:l:.......
//.....'cc;;;:clloddxkkOO000000OOkkxxddoollc::;;;;;;;;;;;::::::::;;;;;;;;;;;::cclloodxxkkOOO00000OOOkxxdollc::;;:l:.......
//.....,lc;;;:clloddxkkOO000000OOkkxxddoollc::;;;;;;;;;;;::::::::;;;;;;;;;;;::cclloodxxkkOOO00000OOOkxxdoolc::;;;lc.......
//.....;oc;;;:clloddxkkOO000000OOkkxxddoollc::;;;;;;;;;;;::::::::;;;;;;;;;;;::cclloodxxkkOOO00000OOOkxxdoolcc:;;;lc'......
//.....;lc;;;:clloddxkkOO000000OOkkxxddoollc::;;;;;;;;;;;::::::::;;;;;;;;;;;::cclloodxxkkOOO000000OOkxxdoolcc:;;;lc'......
//.....;l:;;;:clloddxkkOO000000OOkkxxddoollc::;;;;;;;;;;;::::::::;;;;;;;;;;;::ccllooddxkkOOO000000OOkkxdoolcc:;;;l:'......
//.....;l:;;::clloddxkkOO000000OOkkxxddoollc::;;;;;;;;;;;::::::::;;;;;;;;;;;::ccllooddxkkkOO000000OOkkxdoolcc:;;;c:.......
//.....;c:;;::cllodxxkkOO000000OOkkxxddoollc::;;;;;;;;;;;:::::::::;;;;;;;;;;::cclloodxxkkkOO000000OOkkxdoolcc:;;;c:'......
//.....,c:;;::cllodxxkkOO000000OOkkxxddoollc:::;;;;;;;;;:::::::::::;;;;;;;;;::cllooodxxkkkOO000000OOkkxddolcc:;;;cc'......
//.....;c:;;::cllodxxkkOO000000OOkkxxddoollc:::;;;;;;;;::::::::::::;;;;;;;;;::cclloddxxkkOOO000000OOkkxdoolcc:;;;cl,......
//.....:l:;;::cllodxxkOO000000OOkkxxddoollcc:::;;;;;;;;;::::::::::;;;;;;;;;;:::cclloddxxkkOOO00000OOkkxddolcc:;;;co;......
//.....cl;;;::cllodxkkOO00OOOkkxxxddoolllc::::;;;;;;;;;;;:::::::::;;;;;;;;;;::::cclloooddxxkkkOO000OOkxxdollc:;;;cl;......
//....'cl;;;::clodxxkkkkkkkkkxxddoollccc:::::;;;;;;;;;;::::::::::::;;;;;;;;;;;::::ccclllooddxkkkkkkkkkxxddolc:;;;cl;......
//....'cl;;;:cloddxxkkOO0000OOkkxddoolcc:::::;;;;;;;:::::::::::::::::::;;;;:::::::cclloddxxkOOO000OOkkxxddool:;;;:l,......
//.....cl;;;:lloddxkOO0000000OOkkxxddooollcc:::::::::::::::ccccc:::::::::::c:::ccllooddxxkkOOO000000OOkkxdoolc:;;:c,......
//.....:c;;:cllodxkkOOO000000OOOkkxxxddddollcccccccc::ccccclllllccccc:::cccccccllodddxxxkkkOO0000000OOkkxxdolc:;;:c,......
//....':c;;:cloddxxkkOOOOO00000OOkkxxxdxddollcccclccccclllooooooolllccccccccccllodxxxxxkkkOO0000OOO0OOkkxxdoolc:;:l;......
//....'cc;:cllloddxxdolc::cclodxkkkkkxxxxxddollllllllllllodddddddoollllllllllloddxxxxxkkkxxdolcc::clodxkxddollcc:;l;......
//....'::;:ccllloddc,,'',;;,''',;:cldxkxkkxxddoooollllllodxxxxxxxdoolllllooooddxxkkkxdol:;,,''',;,,'',;lddollccc:;c,......
//.....:c;:ccllool:,'';okOOkl:::cclodxkkkkkxxdddoollllloddxxxxxxxxdoolllloooddxxxkkkkdoolcc:;cdkOkxc,'',coollccc;;:,......
//.....::;:cclllc;''',o00O0K0OOOOOOOOOOkkxxxddddoolllloodxxxxxxxxxddollllooodddxxxkkkOOOOOOOkO00O0KO:''',;lollc:;;:,......
//.....::;:ccll:,',;cok0000000000OOOOOkkkkkxxddooolllooddxxxxxxxxxddooolllooddxxkkkkkOOOOO000000000Oxlc;,';cllc:;;:,......
//.....;:;::clc::ldkOO00000000000OOOOOOOOOOkxxdoollloodddxxxxxxxxxxddooolloodxxkOOOOOOOOOO0000000000OOkxdl:cllc:;;c;......
//.....;:;::cllodxkOOOO0000K00000OOOO000OOkkxdooollloodddxxxxxxxxxxddooollooodxkkOO000OOOO000000000OOOOkkxdollc:;;c;......
//....'::;::cllodxkkOOO0000000000000000OOkxdddooollllooddxxxxxxxxxddoollllooodddxkOOO000000000000000OOOkxxdolcc:;;c;......
//....,c:;::cloodxkkOOO00000000000000OOOkkddddollcclllloodddddddddoolllccclloddddxkOOOO0000000000000OOOkxddolcc:;;c:......
//....;c:;:ccloodxkkOOO00000000000000OOOkkdddoc;;;;;;:cllllloollllllc:;;;;;:codddxkOOOO0000000000000OOOkxxdollc:;;c:'.....
//....:l:;:clloddxxkOO00000000000000OOOOkkxxddollllllllllllooooollllllllllllodddxkkOOOO0000000000000OOOkxxdoolcc:;cc,.....
//....:c;::clloddxxkOO0000000000000OOOOOkkkkkkkxxddoooooooodddddoooooooooddxkkkkkkkOOOOO000000000000OOOkxxdoolcc:;:c,.....
//....cl::cclloddxxkOOO0000000000OOOOOOOkOOOOkkxdddoooooooooddddoooooooooddxxkOOOOkOOOOOO00000000000OOOkxxdoolcc:;cc,.....
//....:l::cclloodxxkkOO000000000OOOOOOOOOOOOOkxdollccccc::::cc::::ccccccllodxkOOOOOOOOOOOO0000000000OOkkxddoolcc::cc'.....
//....;l::ccllooddxkkOO000000000OOOOOOOOOkkxdolc::;;,,,,',,,,,,,,,,,,,,;;::clodxkkOOOOOOOOO00000000OOOkxxddollcc::cc'.....
//....:o:::cclooddxxkOOO00000000OOOOOkxddolc::;;,,,,,''''''''''''''''',,,,;;;:ccloddxkOOOOO00000000OOOkxxdoollcc::ll'.....
//....:oc::cclloddxxkOOO0000000OOOkxdolcc::;;;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,;;::ccllodxkOOO0000000OOkkxddoolcc:::oo,.....
//....cdc:::cclloddxkkOO000000Okxdoolllllccccc::;;;;,,,,,;;;;;;;;,,,,,;;;;:::ccccllllloodxkOO000000OOkkxdoollcc:::oo,.....
//....lxl::::cclloddxkO00000Okxxxdddxddddoolllccc::::::::ccccccc:::::;::::cclllooodddxxxxdxxkkO0000OOkxdoollcc:::cdo,.....
//....cxo:;::cclloodxkO000OOOOOOOOkkkxxxddooooolllllllllloooooooollllllllllloooodddxxkkkOOOOOOOOO00OOkxdollcc::::cdo,.....
//....cxo:;:::cclloodkOO00000000OOkkkxxxdddddooooooolllllllooooollllllooooooooddddxxxkkkOOO00000000Okxdolllcc::;:lxo,.....
//....ckdc;;::cccllodxkkOOOOO0OOOkkkkxxxdddoooolllccc::::::::::::::::cccllloooodddxxxxkkkOOO00OOOOkkxdoollcc:::;:lxd;.....
//....ckd:;:::cclloodxxkkkOOOOOOkkkxxxdddoolllccc::;;;,,,,,,,,,,,,,,;;;:::cclllooodddxxxkkkOOOOOOkkxxddollcc:::;:lxx;.....
//...'okl:;::ccllooddxxxkkkkkkkkxxxddddooolllcccc::;;;,,,,,,,,,,,,,,;;;:::cccllloooddddxxxxkkkkkkkkxxxddollcc:::;cdx;.....
//...'okl;;::ccllooooddddddxxxxxxxxxddddooolllccc:::;;;,,,,,,,,,,,,,;;;::cccclloooddddxxxxxxxxxxddddddooolllcc::;:dx:.....
//...,oxc;;:::cccclllloooddddxxxxxxxxxdddooolllccc::;;;,,,,,,,,,,,,;;;:::ccllloooddddxxxxxxxxddddoooolllccccc:::;;okc.....
//...,dd:,;;;;;:::cccclloooddddxxxxxxxxxdddoolllccc::;;,,,,,,,,,,,,;;;::cccllooodddxxxxxxxxddddooolllccc::::;;;;;;cxc.....
//...,ol;;,,,,;;;;::::cclllooodddxxxxxxxxdddooollccc:;;;,,,,,,,,,,,;;::ccclloodddxxxxxxxxddddooollccc:::;;;;,,,,,;:o:.....
//...,ll::;;;,,,,,;;;:::cccllooodddxxxxxxxxddooollcc::;;,,,,,,,,,,;;;:ccclloodddxxxxxxxxdddoolllcc:::;;;;,,,,;;;::cl:.....
//...;oollcc::;;;,,,,;;;;::ccclloodddxxxxxxxdddoollcc:;;,,,,,,,,,,;;:cccloooddxxxxxxxxddooollcc:::;;;,,,,,;;::ccllldl'....
//...'lxddoolllcc::;;,,,,;;;::cclloodddxxxxxxxddoollcc:;;,,,,,,,,;;;:ccloodddxxxxxxxddoollcc:::;;;,,,;;;::ccllooddxd:.....
//....'cdxxxdddoollcc::;;,,,;;;::ccllooddxxxxxxddoollc::;,,,,,,,,;;:cclooddxxxxxxdddoolcc:::;;;,,;;;::clloodddxxxdl;......
//......,:ldddddddddoollc::;;;,;;;::cclooddxxxxxxddollc:;;,,,,,,,;:cclooddxxxxxdddollcc:;;;,,;;;:ccloodddddddddlc;........
//.........,;clooodddddddoolcc:;;;;;;::clloddxxxxxxdollc:;,,,,,,;;:cloddxxxxxxdoolcc:;;;;;;::cllodddddddoollc;,'..........
//............'',;:cllodddddddollc::;;;;;:cloodxxxxxdool:;;,,,,,;:cloddxxxxddolcc:;;;;;::clodddddddoolc:;,,'..............
//..................'',;::cloddddddolc::;;;;:clodxxxxddoc:;,,,,,;clodxxxxdoolc:;;;;:cloodddddolc:;;,,'....................
//.........................',,;:cloodddoolc:;;;:cldxxxxdoc:,,,,;:lodxxxdolc:;;::clooddoolc:;;,'...........................
//................................',;;:cloooolc::::lodxxdoc;,,;:loxxxdlc:::cloodollc:;,''.................................
//.......................................',;cclooolcccloxdo:,;:cdxdolccclooll::;,'........................................
//.............................................',;::cccloodl:clodollcccc:;,'..............................................
//...................................................'',;:coclooc;;,'.....................................................
//.......................................................':c:::c;.........................................................
//.......................................................':;,;;:;.........................................................
//.....................................................',;cc::ll:;,'......................................................
//..............................................',;:clooolcc:cccllooolc:,'................................................
//........................................',:clodxkkxdlcccccllccccclodxkkxdol:;,'.........................................
//..................................',:codxOOOOkxxdolllllllooooolllllloodxkOOOOkxdlc;,'...................................
//............................';:loxkO0000OOkxxddoooooooooodddoooooooooooodxxkkO00000Okdoc:,'.............................
//.....................',:cldxO0KKK00OkkxxdoollcccccccccccclllllcccccccccccllooddxxkOO00KK0Okxol:;'.......................
//...............',:cldxO00KK00OOkxxddoollc:::;;;;,;;;;;;;:::::::;;;;;;;;;;;;::ccllooddxkkO000KK0Okxol:;,'................
//.........',;:cldxkOO0000000OOkkxxddoolllc::;;;;;,;;;;;;::::::::;;;;;;;;;;;;::cclloooddxkkOOO0000000OOkdolc:;,'..........
//.....',;:clooddxkkOO0000000OOkkxxddoolllc::;;;;;;;;;;;;::::::::;;;;;;;;;;;;::cclloooddxkkkOO000000OOOkxxdoollc:;,'......
//..';;;:::clloddxkkOO0000000OOkkxxddoolllc::;;;;;,;;;;;;::::::::;;;;;;;;;;;;::ccllooodxxkkkOO000000OOOkxxdoolcc::;;;,....
//..:l;;;::clloddxkkOO0000000OOkkxxddoolllc::;;;;;,;;;;;;::::::::;;;;;;;;;;;;::ccllooodxxkkkOO000000OOOkxxdoolcc:;;;:c,...
//.'cl;;;::clloddxkkOO0000000OOkkxxddoolllc::;;;;;,;;;;;;::::::::;;;;;;;;;;;;::ccllooodxxkkOOO0000000OOkxxdoolcc:;;;:c;...
//.'cl;;;::clloddxkkOO0000000OOkkxxddoolllc::;;;;;,;;;;;;::::::::;;;;;;;;;;;;::cclloooddxkkOOO0000000OOkkxdoolcc:;;;:l;...
//.'cc;;;::clloddxkkOO000000OOOkkxxddoolllc:::;;;;,;;;;;;::::::::;;;;;;;;;;;;::cclloooddxkkkOO0000000OOkkxdoolcc:;;;:l:...
//.'cc;;;::clloddxkkOO000000OOOkkxxddoolllc:::;;;;,;;;;;;::::::::;;;;;;;;;;;;::cclllooddxxkkOO0000000OOkxxdoolcc:;;;:oc...
//.,cc;;;:ccllodxxkkOO000000OOOkkxxddoollcc:::;;;;,;;;;;;::::::::;;;;;;;;;;;;::cclllooddxxkkOO0000000OOkkxddolcc::;;:oc'..
//.,lc;;;:ccllodxxkkOO000000OOOkkxxddoollcc::;;;;;,;;;;;;::::::::;;;;;;;;;;;;::cclloooddxxkkOO0000000OOkkxddollc::;;:lc'..
//.,lc;;;:ccllodxxkkOO000000OOOkkxxddoollcc:::;;;;;;;;;;;::::::::;;;;;;;;;;;;::cclloooddxxkkOO0000000OOkkxddollc::;;;lc...
//.;lc;;;:ccloodxxkkOO000000OOOkkxxddoollcc:::;;;;;;;;;;;::::::::;;;;;;;;;;;;::cclllooddxxkkOO0000000OOkkxddollc::;;;l:...

//                                            I am the Master Control Program

#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <getopt.h>
#include <signal.h>
#include <string.h>
#include <termios.h>
#include <unistd.h>

#include <sys/stat.h>

#include "utils.h"
#include "dac.h"
#include "mcp.h"

#if defined(SABRE18) || defined(SABRE28)
#include "display.h"
#include "display-menu.h"
#endif

mcp_state_t *mcp = NULL;
mcp_config_t *cfg = NULL;
mcp_module_t *module = NULL;
mcp_sensors_t *sensors = NULL;

// register a new module in the module chain
// called in each module via macro MCP_REGISTER(...) before main()
void mcp_register(const char *name, const int prio, const init_t init, const stop_t stop, const loop_t loop) {
	mcp_module_t *new_module = malloc(sizeof(mcp_module_t));
	ZERO(new_module);

	new_module->name = name;
	new_module->init = init;
	new_module->stop = stop;
	new_module->loop = loop;
	new_module->next = NULL;

	if (module == NULL)
		// this is the head
		module = new_module;
	else {
		// append to last in chain
		mcp_module_t *m = module;
		while (m->next != NULL)
			m = m->next;
		m->next = new_module;
	}

	xlog("MCP registered module {%d} %s", prio, name);
}

int mcp_status_get(const void *p1, const void *p2) {
#ifdef DAC
	// const menuconfig_t *config = p1;
	const menuitem_t *item = p2;
	xlog("mcp_status_get %i", item->index);
	switch (item->index) {
	case 1:
		return mcp->ir_active;
	default:
		return 0;
	}
#else
	return 0;
#endif
}

void mcp_status_set(const void *p1, const void *p2, int value) {
#ifdef DAC
	// const menuconfig_t *config = p1;
	const menuitem_t *item = p2;
	xlog("mcp_status_set %i", item->index);
	switch (item->index) {
	case 1:
		mcp->ir_active = value;
		return;
	}
#endif
}

void mcp_system_shutdown() {
#ifdef DAC
	if (mcp->dac_power)
		dac_power();
#endif
	xlog("shutting down system now!");
	system("shutdown -h now");
}

void mcp_system_reboot() {
#ifdef DAC
	if (mcp->dac_power)
		dac_power();
#endif
	xlog("rebooting system now!");
	system("shutdown -r now");
}

static void sig_handler(int signo) {
	xlog("MCP received signal %d", signo);
}

static void interactive() {
	struct termios new_io;
	struct termios old_io;

	printf("interactive mode, use keys UP / DOWN / ENTER; quit with 'q'\r\n");

	// set terminal into CBREAK mode
	if ((tcgetattr(STDIN_FILENO, &old_io)) == -1) {
		xlog("cannot set CBREAK");
		exit(EXIT_FAILURE);
	}

	new_io = old_io;
	new_io.c_lflag = new_io.c_lflag & ~(ECHO | ICANON);
	new_io.c_cc[VMIN] = 1;
	new_io.c_cc[VTIME] = 0;

	if ((tcsetattr(STDIN_FILENO, TCSAFLUSH, &new_io)) == -1) {
		xlog("cannot set TCSAFLUSH");
		exit(EXIT_FAILURE);
	}

	while (1) {
		int c = getchar();
		// xlog("console 0x%20x", c);

		if (c == 'q')
			break;

		if (c == 0x1b || c == 0x5b)
			continue; // ignore

		xlog("CONSOLE: distributing key 0x%02x", c);
#ifdef DAC
		dac_handle(c);
#endif
	}

	// reset terminal
	tcsetattr(STDIN_FILENO, TCSANOW, &old_io);
	printf("quit\r\n");
}

static void daemonize() {
	pid_t pid;

	/* Fork off the parent process */
	pid = fork();
	if (pid < 0)
		exit(EXIT_FAILURE);

	if (pid > 0)
		exit(EXIT_SUCCESS);

	if (setsid() < 0)
		exit(EXIT_FAILURE);

	/* Catch, ignore and handle signals */
	signal(SIGCHLD, SIG_IGN);
	signal(SIGHUP, SIG_IGN);

	/* Fork off for the second time*/
	pid = fork();
	if (pid < 0)
		exit(EXIT_FAILURE);

	if (pid > 0)
		exit(EXIT_SUCCESS);

	/* Set new file permissions, set new root, close standard file descriptors */
	umask(0);
	chdir("/");

	close(STDIN_FILENO);
	close(STDOUT_FILENO);
	close(STDERR_FILENO);

	xlog("MCP forked into background");
}

// loop recursively over module chain and call each module's init() function
static void module_init(mcp_module_t *m) {
	if ((m->init)() < 0)
		exit(EXIT_FAILURE);

	xlog("MCP initialized %s", m->name);

	if (m->next != NULL)
		module_init(m->next);
}

// loop recursively (inverted) over module chain, stop loop() threads and call stop() function
static void module_stop(mcp_module_t *m) {
	if (m->next != NULL)
		module_stop(m->next);

	if (m->loop != NULL) {
		if (pthread_cancel(m->thread))
			xlog("MCP error canceling thread");

		if (pthread_join(m->thread, NULL))
			xlog("MCP error joining thread");
	}

	(m->stop)();

	xlog("MCP stopped %s", m->name);
}

// loop recursively over module chain and call each module's loop() function in a new thread
static void module_loop(mcp_module_t *m) {
	if (m->loop != NULL)
		if (pthread_create(&m->thread, NULL, (void* (*)(void*)) m->loop, NULL))
			exit(EXIT_FAILURE);

	xlog("MCP started thread %s", m->name);

	if (m->next != NULL)
		module_loop(m->next);
}

int main(int argc, char **argv) {
	xlog("MCP startup");

	// allocate global data exchange structures
	cfg = malloc(sizeof(*cfg));
	ZERO(cfg);

	mcp = malloc(sizeof(*mcp));
	ZERO(mcp);
	mcp->ir_active = 1;
	mcp->notifications_lcd = 1;
	mcp->notifications_sound = 1;
	mcp->notifications_desktop = 0;

	sensors = malloc(sizeof(*sensors));
	ZERO(sensors);

	// parse command line arguments
	int c;
	while ((c = getopt(argc, argv, "di")) != -1) {
		switch (c) {
		case 'd':
			cfg->daemonize = 1;
			break;
		case 'i':
			cfg->interactive = 1;
			break;
		}
	}

	// fork into background
	// not necessary anymore, see https://jdebp.uk/FGA/unix-daemon-design-mistakes-to-avoid.html
	if (cfg->daemonize)
		daemonize();

	// install signal handler
	if (signal(SIGINT, sig_handler) == SIG_ERR) {
		xlog("can't catch SIGINT");
		exit(EXIT_FAILURE);
	}
	if (signal(SIGTERM, sig_handler) == SIG_ERR) {
		xlog("can't catch SIGTERM");
		exit(EXIT_FAILURE);
	}
	if (signal(SIGHUP, sig_handler) == SIG_ERR) {
		xlog("can't catch SIGHUP");
		exit(EXIT_FAILURE);
	}

	// initialize all modules
	module_init(module);

	// start main loop of all modules
	module_loop(module);

	if (cfg->interactive) {
		xlog("MCP online, waiting for input");
		interactive();
	} else {
		xlog("MCP online");
		pause();
	}

	// stop all modules
	module_stop(module);
	xlog("MCP all modules terminated, hasta la vista, baby...");

	xlog_close();
	return EXIT_SUCCESS;
}
